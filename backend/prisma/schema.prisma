// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output = "./../src/generated/"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model UserProfile {
  userId            String   @id                // Supabase UID
  defaultBufferMin  Int      @default(5)
  walkingSpeedFactor Float   @default(1.0)
  campusHomeLabel   String?
  campusHomeLat     Float?
  campusHomeLng     Float?

  notificationsEnabled Boolean @default(true)
  quietHoursStart    String? // e.g. "22:00"
  quietHoursEnd      String? // e.g. "07:00"

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  calendarSnapshots  CalendarSnapshot[]
  walkSegments       WalkSegment[]
}

model CalendarSnapshot {
  id           String   @id @default(cuid())
  userId       String
  capturedAt   DateTime @default(now())
  eventsJson   Json     // normalized events for a rolling window
  calendarSyncId String?

  user         UserProfile @relation(fields: [userId], references: [userId])
  walkSegments WalkSegment[]

  @@index([userId, capturedAt])
}

model WalkSegment {
  id              String   @id @default(cuid())
  userId          String
  calendarEventId String
  snapshotId      String

  departureTime   DateTime
  arrivalTime     DateTime
  etaMinutes      Int
  bufferMinutes   Int

  originLabel      String?
  originLat        Float
  originLng        Float
  destinationLabel String?
  destinationLat   Float
  destinationLng   Float

  status          String   @default("scheduled")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            UserProfile      @relation(fields: [userId], references: [userId])
  snapshot        CalendarSnapshot @relation(fields: [snapshotId], references: [id])

  @@index([userId, departureTime])
  @@index([userId, calendarEventId])
}

